---
title: "Reproducibilidade de CÃ³digo com o R"

categories: [R, reproducibilidade]

# MUDE APENAS ANO DIA E MES PARA O DIA QUE VOCE NOS ENVIOU
date: '2021-06-16T00:00:00Z' 

draft: no

featured: no

gallery_item: null

image:
  caption: 
  focal_point: 
  preview_only: 
  
  projects: []

subtitle: null

summary: null

# DIGITE NA LISTA ABAIXO OS TRACKS DO SEU CODIGO
tags: 
  - Open Data
  - R
  - reproducibilidade
  
# DIGITE NA LISTA ABAIXO O NOME DE TODOS OS AUTORES SEM ESPACOS
authors:
  - MarceloPerlin
  - MarcosHenriqueReichert
  - LucasMussoi


---

<script type="text/javascript" src="//cdn.plu.mx/widget-popup.js"></script>

<a href="https://plu.mx/plum/a/?doi=10.17632%2Fscpb9gnsgm.1" data-popup="right" data-size="large" class="plumx-plum-print-popup" data-site="plum" data-hide-when-empty="true">Reproducibilidade de Código com o R published at the &amp;quot;Open Code Community&amp;quot;</a>



Uma pesquisa baseada em dados Ã© reproduzÃ­vel quando outros cientistas
conseguem replicar os seus resultados. O benefÃ­cio para a ciÃªncia Ã©
Ã³bvio: diferentes pesquisadores podem repetir experimentos
computacionais e testar novas hipÃ³teses com base em resultados jÃ¡
estabelecidos. Claramente, polÃ­ticas de reproducibilidade sÃ£o uma
condiÃ§Ã£o necessÃ¡ria para promovermos a ciÃªncia perante uma audiÃªncia
cada vez mais crÃ­tica do trabalho acadÃªmico. Como confiar em resultados
os quais nÃ£o permitem replicaÃ§Ã£o? Seria a palavra do pesquisador
suficiente? Claro que nÃ£o..

Apesar de parecer uma premissa simples, a prÃ¡tica de reproducibilidade
em pesquisa baseada em dados Ã© complexa. No mundo ideal, o mesmo
*script* de pesquisa â€“ cÃ³digo de computador que produz grÃ¡ficos e
tabelas â€“ deveria sempre produzir os mesmos resultados. Na prÃ¡tica,
entretanto, todo cÃ³digo de programaÃ§Ã£o possui diversas dependÃªncias: o
**sistema operacional** (Windows/Mac/Linux), a **plataforma
estatÃ­stica** utilizada (R/Python/Stata/..) e **versÃµes das funÃ§Ãµes
especÃ­ficas** de cada plataforma. Uma maneira estruturada de entender o
problema Ã© imaginar um *grid* com todas estas possÃ­veis combinaÃ§Ãµes de
plataforma computacional, versÃµes de software e funÃ§Ãµes para a pesquisa.
Uma pesquisa Ã© reproduzÃ­vel se, dada a mesma entrada de dados, a saÃ­da
do programa (grÃ¡fico/tabela) Ã© equivalente em todas combinaÃ§Ãµes do
*grid*.

Como professor e pesquisador, jÃ¡ vivenciei situaÃ§Ãµes onde a
reproducibilidade de cÃ³digo nÃ£o persiste, com alguns casos mais graves
que outros. Aprendi a lidar com a reproducibilidade na marra, com erros
e acertos. Assim, neste pequeno artigo irei mostrar o que a plataforma R
tem para oferecer em termos de reproducibilidade e compartilhar o que
aprendi no processo.

# Reproducibilidade com o R

## OrganizaÃ§Ã£o de pastas e arquivos

O primeiro e mais simples movimento para melhorar a reproducibilidade de
cÃ³digo Ã© organizar os seus arquivos. Pode parecer bobagem, mas uma
bÃ¡sica organizaÃ§Ã£o facilita muito o processo de execuÃ§Ã£o de cÃ³digos
antigos. Quem nunca baixou um cÃ³digo estilo *miojo* da internet?

Por exemplo, imagine vocÃª abrir uma pasta com um projeto antigo e se
deparar com o seguinte cenÃ¡rio:

    ## Loading required package: fs

    ## /tmp/Rtmp3rqa7g/Minha-Pesquisa
    ## â”œâ”€â”€ data
    ## â”‚   â”œâ”€â”€ dados-atualizados.csv
    ## â”‚   â””â”€â”€ dados-finais.csv
    ## â”œâ”€â”€ script-artigo-final2--REVISADO.R
    ## â”œâ”€â”€ script-download-dados.R
    ## â”œâ”€â”€ script-download-dados2.R
    ## â”œâ”€â”€ tabela-final1.xlsx
    ## â””â”€â”€ tabela-final2-antes-de-filtrar.xlsx

Neste caso temos trÃªs scripts do R, uma pasta com dados e dois arquivos
.csv. Os nomes dos arquivos tambÃ©m nÃ£o ajudam. Afinal, qual arquivo
representa os dados utilizados na pesquisa publicada? O que parece Ã³bvio
no momento de ediÃ§Ã£o do projeto, ou uma semana depois, nÃ£o serÃ¡ tÃ£o
Ã³bvio em seis meses. Se nÃ£o Ã© Ã³bvio para o prÃ³prio autor, imagine para
outras pessoas.

Como sugestÃ£o, e deixo claro que a forma de organizaÃ§Ã£o Ã©
intrinsicamente gosto pessoal, entendo que a melhor estrutura Ã© aquela
mais simples e Ã³bvia. Um exemplo para o projeto anterior seria a
seguinte organizaÃ§Ã£o de arquivos e pastas:

    ## /tmp/Rtmp3rqa7g/Minha-Pesquisa-oganizada
    ## â”œâ”€â”€ 01-import-clean-data.R
    ## â”œâ”€â”€ 02-make-tables.R
    ## â”œâ”€â”€ data
    ## â”‚   â””â”€â”€ dados-pesquisa-2021-05-01.rds
    ## â”œâ”€â”€ fcts
    ## â”‚   â””â”€â”€ fcts-models.R
    ## â”œâ”€â”€ figs
    ## â”‚   â”œâ”€â”€ p1-variable-over-time.png
    ## â”‚   â””â”€â”€ p2-distribution-plot.png
    ## â””â”€â”€ tabs
    ##     â”œâ”€â”€ tab01-summary-stats.tex
    ##     â””â”€â”€ tab02-ols-model.tex

Daqui a um ano ou mais, caso eu ou outra pessoa retorne a este projeto,
a estrutura de arquivos e pastas permite o fÃ¡cil e rÃ¡pido entendimento
do cÃ³digo: dois *script* numerados e sequenciados
(`01-import-clean-data.R` e `02-make-tables.R`), um de dados com data
`dados-pesquisa-2021-05-01.rds` e pastas para as saÃ­das em tabelas
(`tabs/`) e figuras (`figs/`).

Assim, como critÃ©rios pessoais, utilizo as seguintes regras:

-   Na pasta raiz do projeto, somente cÃ³digo R pode existir (todo o
    resto, arquivos de figura, tabelas, dados, devem ir em pasta
    prÃ³pria);
-   Se os scripts possuem ordem de execuÃ§Ã£o, use numeraÃ§Ã£o no nome, de
    forma a ficar claro o sequenciamento (ex. 01-import-data.R,
    02-clean-data.R, 03-make-tables.R);
-   Se dados podem mudar com o tempo, usar uma data na nomeaÃ§Ã£o do
    arquivo (ex: dados-tesouro-direto\_2021-01-05.csv);
-   Figuras e tabelas devem ser nomeadas na ordem em que aparecem no
    artigo ou relatÃ³rio (ex. p1-grafico-tempo.png, p2-histograma.png,
    tab1-descritiva.tex, etc)

## Pacote `renv`

Pacote `renv` tem uma missÃ£o especÃ­fica: controlar e gerenciar pacotes
de projetos. Sua estrutura e funcionamento Ã© muito semelhante ao
[*Virtual Enviromnent
(venv)*](https://docs.python.org/3/tutorial/venv.html) do Python. A
grosso modo, a partir de um diretÃ³rio de trabalho, registramos os
pacotes utilizados â€“ incluindo versÃµes â€“ em um arquivo local chamado
`renv.lock`. ApÃ³s isso, podemos copiar o cÃ³digo para outra mÃ¡quina e
restaurar todos pacotes e suas versÃµes especÃ­ficas com um simples
comando. Isto Ã©, reproduzimos o ambiente especÃ­fico do projeto em termos
de pacotes e versÃµes do R.

O primeiro passo para usar `renv` Ã© definir uma pasta de trabalho onde
cÃ³digo R e arquivos dados irÃ£o viver. Ao mudar o diretÃ³rio para esta
pasta com `setwd` ou usando a ferramenta de projetos do RStudio, a qual
jÃ¡ muda o diretÃ³rio automaticamente para onde o arquivo de projeto
existe, basta inicializar o `renv` com comando `renv::init()`. O que
este comando irÃ¡ fazer Ã© ler os scripts do R existentes na raiz e
subdiretÃ³rios da pasta atual, localizar no cÃ³digo as chamadas a
`library/require` ou `::`, e registrar **todas** as dependÃªncias de
pacotes. Por exemplo, se fizeres uma chamada a `library(dplyr)` em um
cÃ³digo de R na pasta (ou subpasta) de trabalho, o `renv::init()` irÃ¡
identificar esta dependÃªncia.

ApÃ³s inicializarmos o `renv` no projeto, basta registrar as dependÃªncias
â€“ pacotes e suas versÃµes â€“ com o comando `renv::snapshot()`, e pronto!
Agora, quando copiarmos o cÃ³digo para outro computador, basta usar
`renv::restore()` para instalar e usar todas as dependÃªncias do projeto.
Resumindo:

1.  Abra o projeto e use `renv::init()` para inicializar o `renv`;
2.  Use `renv::snapshot()` para registar todos pacotes e versÃµes;
3.  Use `renv::install()` para instalar novos pacotes (funÃ§Ã£o
    `install.packages()` Ã© sobrescrito por `renv` e funciona da mesma
    forma);
4.  Use `renv::update()` para atualizar todos pacotes, incluindo pacotes
    instalados do Github.

Para mais detalhes sobre `renv`, veja o [site
oficial](https://rstudio.github.io/renv/articles/renv.html). Eu uso o
`renv` em todos os meus projetos e sÃ³ tenho elogios:

-   O *overhead* de tempo para instalaÃ§Ã£o e configuraÃ§Ã£o Ã© mÃ­nimo;
-   A pasta de trabalho tem um aumento pequeno de tamanho pois todos
    pacotes sÃ£o na verdade links simbÃ³licos (e nÃ£o arquivos locais);
-   Facilita muito o uso de pacotes em computadores diferentes. Ao
    copiar a pasta, basta digitar um comando para sincronizar a mÃ¡quina
    com todos os pacotes do projeto;

## Pacote `checkpoint`

Pacote `checkpoint` Ã© uma iniciativa da
[Microsoft](https://mran.microsoft.com/documents/rro/reproducibility/)
para aumentar a reproducibilidade de cÃ³digos em R. A grande sacada do
pacote Ã© utilizar o tempo, e nÃ£o projetos, para definir as versÃµes dos
pacotes. Podes, por exemplo, usar todas versÃµes dos pacotes na data
`2020-01-05`. O pacote acessa um repositÃ³rio atualizado com as linhas de
tempo das versÃµes e instala apenas aquelas disponÃ­veis na data de
referÃªncia.

Assim como para o `renv`, o uso do `checkpoint` Ã© bastante simples,
basta carregar o pacote no topo do script e chamar a principal funÃ§Ã£o
com uma data, como em:

    library(checkpoint)

    checkpoint("2020-01-01")  

    # resto do cÃ³digo aqui

O que o `checkpoint` irÃ¡ fazer Ã© definir um repositÃ³rio local para os
pacotes, buscar pacotes utilizados no cÃ³digo, e instalar todas versÃµes
disponÃ­veis naquela data em particular, incluindo as versÃµes das
dependÃªncias. A partir disso, o resto do cÃ³digo acessarÃ¡ o repositÃ³rio
local do `checkpoint` para buscar todos os pacotes utilizados nos
scripts.

Pessoalmente, acho a forma de utilizar o `checkpoint` bem interessante
porÃ©m um pouco gananciosa no sentido de tentar oferecer uma soluÃ§Ã£o
mÃ¡gica para o problema de reproducibilidade. Na prÃ¡tica, ao usar o
`checkpoint` em meus projetos, vejo os seguintes problemas:

-   A instalaÃ§Ã£o de todos pacotes na inicializaÃ§Ã£o do `checkpoint` acaba
    exigindo certo tempo de processamento pois **todas** as dependÃªncias
    devem que ser reinstaladas;
-   A primeira data do repositÃ³rio de pacotes Ã© `'2014-09-17'`, o que
    pode nÃ£o ser suficiente para projetos mais antigos;
-   DependÃªncias externas ao R, como software instalado via apt do
    linux, nÃ£o sÃ£o resolvidas. Assim, no futuro, sem a garantia de que
    dependÃªncias externas serÃ£o sempre disponÃ­veis, a reproducibilidade
    fica comprometida;
-   Adiciona um **custo de armazenamento** significativo. Ao reinstalar
    pacotes, um projeto mÃ­nimo pode ter tamanho maior que 100 MB,
    simplesmente pelo uso de um reposÃ­tÃ³rio customizado.

Para mais detalhes, veja a pÃ¡gina do projeto no
[Github](https://github.com/RevolutionAnalytics/checkpoint).

## ConteinarizaÃ§Ã£o â€“ docker

Hoje em dia Ã© impossÃ­vel falar de reproducibilidade sem mencionar a
tecnologia *docker*. Primeiramente pensada para a execuÃ§Ã£o de cÃ³digos em
produÃ§Ã£o â€“ sistemas ativos e importantesâ€“, o *docker* permite a criaÃ§Ã£o
de uma imagem de um sistema operacional dentro do seu computador. Na
minha opiniÃ£o, atualmente o *docker* Ã© o Ã¡pice do que se consegue em
termos de reproducibilidade computacional, justificando o seu uso
sistÃªmico na indÃºstria.

Por exemplo, digamos que voce tenha um cÃ³digo em R desenvolvido no
sistema operacional [Ubuntu 18.04](https://ubuntu.com/), e versÃµes
especÃ­ficas de software via apt e pacotes do R. Assim, podes criar uma
imagem para recriar este ambiente computacional no seu computador,
instalar todas as dependÃªncias, incluindo software por apt-get e pacotes
do R e, por fim, executar o cÃ³digo dentro da imagem e exportar
resultados para arquivos Excel ou .csv. Assim, mesmo que estejas usando
Windows 10, podes rodar o cÃ³digo R no sistema Ubuntu 18.04.

O uso do docker com o R vai muito alÃ©m deste artigo, exigindo
conhecimento sobre arquiteturas e cÃ³digos em linha de comando. Em
resumo, utilizar *docker* resume-se a 1) baixar uma imagem de um sistema
operacional, 2) escrever um `Dockerfile` com todos os passos de
preparaÃ§Ã£o do sistema para execuÃ§Ã£o de *scripts* e 3) executar o cÃ³digo.
Para quem quiser conhecer mais, um tutorial muito bom estÃ¡ disponÃ­vel
[aqui](https://colinfay.me/docker-r-reproducibility/). Um vÃ­deo
ilustrativo estÃ¡ disponÃ­vel no
[Youtube](https://www.youtube.com/watch?v=CdG7gUPgdWU).

# ConclusÃ£o

Reproducibilidade no R nÃ£o Ã© uma tarefa fÃ¡cil, mas os pacotes existentes
hoje ajudam bastante. Particularmente, uso o `renv` em todos os projetos
que faÃ§o e estou muito satisfeito. Entendo que o `renv` fornece o
equilÃ­brio entre reproducibilidade e inconveniÃªncia, nÃ£o atrapalhando o
desenvolvimento do cÃ³digo. Quem quiser saber mais sobre
reproducibilidade no R, o prÃ³prio CRAN tem uma [pÃ¡gina
especial](https://cran.r-project.org/web/views/ReproducibleResearch.html)
sobre o tÃ³pico. LÃ¡ encontrarÃ¡s diversos outros pacotes voltados a
reproducibilidade e nÃ£o citados aqui.



{{% callout note %}}

**Please, cite this work:**

Perlin, Marcelo; Reichert, Marcos Henrique; Mussoi, Lucas (2021), "Reproducibilidade de Código com o R published at the "Open Code Community"", Mendeley Data, V1, doi: 10.17632/scpb9gnsgm.1

{{% /callout %}}


